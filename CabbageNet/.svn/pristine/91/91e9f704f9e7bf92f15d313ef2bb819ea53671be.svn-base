//
//  LoginViewController.m
//  CabbageNet
//
//  Created by MacAir on 2017/4/6.
//  Copyright © 2017年 MacAir. All rights reserved.
//

#import "LoginViewController.h"
#import "RegisterViewController.h"
#import "ForgetViewController.h"
#import "BaseTabBarController.h"
#import <UMSocialCore/UMSocialCore.h>
#import "AddUserInfoViewController.h"

@interface LoginViewController ()

@property (weak, nonatomic) IBOutlet UITextField *phoneField;
@property (weak, nonatomic) IBOutlet UITextField *pwdField;
@property (weak, nonatomic) IBOutlet UIButton *loginBtn;

@end

@implementation LoginViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    _phoneField.placeholder = @"请输入用户名／邮箱／手机号";
    self.loginBtn.layer.cornerRadius = 5;
    self.loginBtn.layer.masksToBounds = YES;
    self.loginBtn.backgroundColor = mAppMainColor;
}

- (IBAction)loginBtnClick {
    
    NSMutableDictionary * infoDic = [[NSMutableDictionary alloc]init];
    setDickeyobj(infoDic, @"login", @"api");
//    setDickeyobj(infoDic, @"mobilelogin", @"api");
    setDickeyobj(infoDic, self.phoneField.text, @"mobile");
    setDickeyobj(infoDic, self.pwdField.text, @"password");
    
    NSMutableDictionary * param = [[NSMutableDictionary alloc]init];
    setDickeyobj(param, infoDic, @"reqBody");
    
    [CKHttpCommunicate createRequest:HTTP_USER_API WithParam:param withMethod:POST success:^(id result) {
        
        if (SUCCESS_REQUEST(result)) {
            
            UserInfoModel *model = [[UserInfoModel alloc] init];
            [model mj_setKeyValues:result[@"data"]];
            [UserInfoModel storeUserWithModel:model];
            
            UserDefaultsSynchronize(@"10001", @"login");
            [self.view endEditing:YES];
            [self.navigationController popToViewController:[self.navigationController.viewControllers objectAtIndex:0] animated:YES];
            
        }else {
            [MBProgressHUD showError:result[@"msg"] toView:nil];
        }
        
    } failure:^(NSError *erro) {
        NSLog(@"%@",erro);
    } showHUD:nil];
    
    
}

- (IBAction)registerBtnClick {
    
    RegisterViewController *controller = [[UIStoryboard storyboardWithName:@"Main" bundle:nil] instantiateViewControllerWithIdentifier:@"registerViewController"];
    [self.navigationController pushViewController:controller animated:YES];
    
}

- (IBAction)forgetBtnClick {
    
    ForgetViewController *controller = [[UIStoryboard storyboardWithName:@"Main" bundle:nil] instantiateViewControllerWithIdentifier:@"forgetViewController"];
    [self.navigationController pushViewController:controller animated:YES];
}

- (IBAction)qqLogin {
    [[UMSocialManager defaultManager] getUserInfoWithPlatform:UMSocialPlatformType_QQ currentViewController:nil completion:^(id result, NSError *error) {
        if (error) {
            NSLog(@"%@",error);
        } else {
            UMSocialUserInfoResponse *resp = result;
            
            NSMutableDictionary * infoDic = [[NSMutableDictionary alloc]init];
            setDickeyobj(infoDic, @"checkbind", @"api");
            setDickeyobj(infoDic, @"qq", @"type");
            setDickeyobj(infoDic, resp.openid, @"keyid");
            
            NSMutableDictionary * param = [[NSMutableDictionary alloc]init];
            setDickeyobj(param, infoDic, @"reqBody");
            
            [CKHttpCommunicate createRequest:HTTP_USER_API WithParam:param withMethod:POST success:^(id result) {

                if (SUCCESS_REQUEST(result)) {
                    id resultdata = result[@"data"];
                    if ([[resultdata class] isSubclassOfClass:[NSDictionary class]]) {
                        UserInfoModel *model = [[UserInfoModel alloc] init];
                        [model mj_setKeyValues:result[@"data"]];
                        [UserInfoModel storeUserWithModel:model];
                        
                        UserDefaultsSynchronize(@"10001", @"login");
                        [self.view endEditing:YES];
                        [self.navigationController popToViewController:[self.navigationController.viewControllers objectAtIndex:0] animated:YES];
                    }else{
                        AddUserInfoViewController *controller = [[UIStoryboard storyboardWithName:@"Main" bundle:nil] instantiateViewControllerWithIdentifier:@"addUserInfoViewController"];
                        controller.type = @"qq";
                        controller.keyid = resp.openid;
                        controller.info = resp.accessToken;
                        [self.navigationController pushViewController:controller animated:YES];
                    }
                }else {
                    [MBProgressHUD showError:result[@"msg"] toView:nil];
                }
                
            } failure:^(NSError *erro) {
                NSLog(@"%@",erro);
            } showHUD:nil];
        }
    }];
}

- (IBAction)weixinLogin {
    
    [[UMSocialManager defaultManager] getUserInfoWithPlatform:UMSocialPlatformType_WechatSession currentViewController:nil completion:^(id result, NSError *error) {
        if (error) {
            NSLog(@"----%@",error);
        } else {
            UMSocialUserInfoResponse *resp = result;
        
            NSMutableDictionary * infoDic = [[NSMutableDictionary alloc]init];
            setDickeyobj(infoDic, @"checkbind", @"api");
            setDickeyobj(infoDic, @"wechat", @"type");
            setDickeyobj(infoDic, resp.openid, @"keyid");
            
            NSMutableDictionary * param = [[NSMutableDictionary alloc]init];
            setDickeyobj(param, infoDic, @"reqBody");
            
            [CKHttpCommunicate createRequest:HTTP_USER_API WithParam:param withMethod:POST success:^(id result) {
                
                if (SUCCESS_REQUEST(result)) {
                    id resultdata = result[@"data"];
                    if ([[resultdata class] isSubclassOfClass:[NSDictionary class]]) {
                        UserInfoModel *model = [[UserInfoModel alloc] init];
                        [model mj_setKeyValues:result[@"data"]];
                        [UserInfoModel storeUserWithModel:model];
                        
                        UserDefaultsSynchronize(@"10001", @"login");
                        [self.view endEditing:YES];
                        [self.navigationController popToViewController:[self.navigationController.viewControllers objectAtIndex:0] animated:YES];
                    }else{
                        AddUserInfoViewController *controller = [[UIStoryboard storyboardWithName:@"Main" bundle:nil] instantiateViewControllerWithIdentifier:@"addUserInfoViewController"];
                        controller.type = @"wechat";
                        controller.keyid = resp.openid;
                        controller.info = resp.accessToken;
                        [self.navigationController pushViewController:controller animated:YES];
                        

                    }
                    
                }else {
                    [MBProgressHUD showError:result[@"msg"] toView:nil];
                }
                
            } failure:^(NSError *erro) {
                NSLog(@"%@",erro);
            } showHUD:nil];
        }
    }];
}

- (IBAction)weiboLogin{
    
    
    [[UMSocialManager defaultManager] getUserInfoWithPlatform:UMSocialPlatformType_Sina currentViewController:nil completion:^(id result, NSError *error) {
        if (error) {
            NSLog(@"----%@",error);
        } else {
            UMSocialUserInfoResponse *resp = result;

            NSMutableDictionary * infoDic = [[NSMutableDictionary alloc]init];
            setDickeyobj(infoDic, @"checkbind", @"api");
            setDickeyobj(infoDic, @"sina", @"type");
            setDickeyobj(infoDic, resp.openid, @"keyid");
            
            NSMutableDictionary * param = [[NSMutableDictionary alloc]init];
            setDickeyobj(param, infoDic, @"reqBody");
            
            [CKHttpCommunicate createRequest:HTTP_USER_API WithParam:param withMethod:POST success:^(id result) {
                
                if (SUCCESS_REQUEST(result)) {
                    id resultdata = result[@"data"];
                    if ([[resultdata class] isSubclassOfClass:[NSDictionary class]]) {
                        UserInfoModel *model = [[UserInfoModel alloc] init];
                        [model mj_setKeyValues:result[@"data"]];
                        [UserInfoModel storeUserWithModel:model];
                        
                        UserDefaultsSynchronize(@"10001", @"login");
                        [self.view endEditing:YES];
                        [self.navigationController popToViewController:[self.navigationController.viewControllers objectAtIndex:0] animated:YES];
                    }else{
                        AddUserInfoViewController *controller = [[UIStoryboard storyboardWithName:@"Main" bundle:nil] instantiateViewControllerWithIdentifier:@"addUserInfoViewController"];
                        controller.type = @"sina";
                        controller.keyid = resp.openid;
                        controller.info = resp.accessToken;
                        [self.navigationController pushViewController:controller animated:YES];

                    }
                    
                }else {
                    [MBProgressHUD showError:result[@"msg"] toView:nil];
                }
                
            } failure:^(NSError *erro) {
                NSLog(@"%@",erro);
            } showHUD:nil];
        }
    }];
}


@end
